<!DOCTYPE html>
<!-- saved from url=(0053)http://www.expressjs.com.cn/guide/error-handling.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Express 中的错误处理</title>
      
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <link rel="stylesheet" href="./10Express 中的错误处理_files/style.css">
      <link rel="stylesheet" href="./10Express 中的错误处理_files/dropit.css">
      <link rel="stylesheet" href="./10Express 中的错误处理_files/prism.css">
      <link href="./10Express 中的错误处理_files/font-awesome.min.css" rel="stylesheet">
      <link rel="stylesheet" href="./10Express 中的错误处理_files/css">
  
      <script src="http://hm.baidu.com/hm.js?407473d433e871de861cf818aa1405a1"></script><script src="./10Express 中的错误处理_files/hm.js.下载"></script><script data-cfasync="false" src="./10Express 中的错误处理_files/jquery.min.js.下载"></script>
      <script data-cfasync="false" src="./10Express 中的错误处理_files/app.js.下载"></script>
      <script data-cfasync="false" src="./10Express 中的错误处理_files/retina.js.下载"></script>
      <script data-cfasync="false" src="./10Express 中的错误处理_files/dropit.js.下载"></script>
      <script data-cfasync="false" src="./10Express 中的错误处理_files/prism.js.下载"></script>
      <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?1e9527683dc35951cb595bc55ece8e84";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script></head>

  <body rlt="1">

    <section class="content">

      <header>
        <div id="mobile-menu">
            <div id="nav-button" class="fa fa-bars fa-2x button"></div>
        </div>
        <section id="logo"><a href="http://www.expressjs.com.cn/" class="express">Express</a>
        </section>
        <div id="navbar">
            <ul id="navmenu">
                <li><a href="http://www.expressjs.com.cn/" id="home-menu">首页</a></li>
                <li>
                    <ul id="getting-started-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/starter/installing.html">入门</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/installing.html">
                                    安装
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/hello-world.html">
                                    Hello world
                                  </a>
                                </li>
                                <li>
                                <a href="http://www.expressjs.com.cn/starter/generator.html">
                                  Express 应用生成器
                                </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/basic-routing.html">
                                    基本路由
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/static-files.html">
                                    静态文件
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/faq.html">
                                    常见问题
                                  </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="guide-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/guide/routing.html">使用指南</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/guide/routing.html">路由</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/error-handling.html">错误处理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/debugging.html">调试</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/behind-proxies.html">为 Express 设置代理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/migrating-4.html">升级到 Express 4</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/database-integration.html">数据库集成</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="application-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/4x/api.html">API 中文手册</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/4x/api.html">4.x 版本</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/3x/api.html">3.x 版本</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="advanced-topics-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">进阶话题</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/pm.html">进程管理器</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/security-updates.html">安全更新</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="resources-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/resources/glossary.html">有用的资源</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/resources/glossary.html">术语表</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/community.html">社区</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/books-blogs.html">书籍与博客</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/applications.html">实例展示</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
      </header>
      <div id="overlay"></div>
    
      
<h1 id="section">错误处理</h1>

<p>定义错误处理中间件和定义其他中间件一样，除了需要 4 个参数，而不是 3 个，其格式如下 <code>(err, req, res, next)</code>。例如：</p>

<pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'Something broke!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>在其他 <code>app.use()</code> 和路由调用后，最后定义错误处理中间件，比如：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> methodOverride <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'method-override'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">bodyParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">methodOverride<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 业务逻辑
</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>中间件返回的响应是随意的，可以响应一个 HTML 错误页面、一句简单的话、一个 JSON 字符串，或者其他任何您想要的东西。</p>

<p>为了便于组织（更高级的框架），您可能会像定义常规中间件一样，定义多个错误处理中间件。比如您想为使用 XHR 的请求定义一个，还想为没有使用的定义一个，那么：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> methodOverride <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'method-override'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">bodyParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">methodOverride<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>logErrors<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>clientErrorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p><code>logErrors</code> 将请求和错误信息写入标准错误输出、日志或类似服务：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">function</span> <span class="token function">logErrors<span class="token punctuation">(</span></span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p><code>clientErrorHandler</code> 的定义如下（注意这里将错误直接传给了 <code>next</code>）：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">function</span> <span class="token function">clientErrorHandler<span class="token punctuation">(</span></span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'Something blew up!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>

<p><code>errorHandler</code> 能捕获所有错误，其定义如下：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">function</span> <span class="token function">errorHandler<span class="token punctuation">(</span></span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>如果向 <code>next()</code> 传入参数（除了 ‘route’ 字符串），Express 会认为当前请求有错误的输出，因此跳过后续其他非错误处理和路由/中间件函数。如果需做特殊处理，需要创建新的错误处理路由，如下节所示。</p>

<p>如果路由句柄有多个回调函数，可使用 ‘route’ 参数跳到下一个路由句柄。比如：</p>

<pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/a_route_behind_paywall'</span><span class="token punctuation">,</span> 
  <span class="token keyword">function</span> <span class="token function">checkIfPaidSubscriber<span class="token punctuation">(</span></span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>hasPaid<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    
      <span class="token comment" spellcheck="true">// 继续处理该请求
</span>      <span class="token function">next<span class="token punctuation">(</span></span><span class="token string">'route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">getPaidContent<span class="token punctuation">(</span></span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    PaidContent<span class="token punctuation">.</span><span class="token function">find<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json<span class="token punctuation">(</span></span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>在这个例子中，句柄 <code>getPaidContent</code> 会被跳过，但 <code>app</code> 中为 <code>/a_route_behind_paywall</code> 定义的其他句柄则会继续执行。</p>

<div class="doc-box doc-info">
  <p><code>next()</code> 和 <code>next(err)</code> 类似于 <code>Promise.resolve()</code> 和 <code>Promise.reject()</code>。它们让您可以向 Express 发信号，告诉它当前句柄执行结束并且处于什么状态。<code>next(err)</code> 会跳过后续句柄，除了那些用来处理错误的句柄。</p>
</div>

<h2 id="section-1">缺省错误处理句柄</h2>

<p>Express 内置了一个错误处理句柄，它可以捕获应用中可能出现的任意错误。这个缺省的错误处理中间件将被添加到中间件堆栈的底部。</p>

<p>如果你向 <code>next()</code> 传递了一个 error ，而你并没有在错误处理句柄中处理这个 error，Express 内置的缺省错误处理句柄就是最后兜底的。最后错误将被连同堆栈追踪信息一同反馈到客户端。堆栈追踪信息并不会在生产环境中反馈到客户端。</p>

<div class="doc-box doc-info">
  <p>设置环境变量 <code>NODE_ENV</code> 为 “production” 就可以让应用运行在生产环境模式下。</p>
</div>

<p>如果你已经开始向 response 输出数据了，这时才调用 <code>next()</code> 并传递了一个 error，比如你在将向客户端输出数据流时遇到一个错误，Express 内置的缺省错误处理句柄将帮你关闭连接并告知 request 请求失败。</p>

<p>因此，当你添加了一个自定义的错误处理句柄后，如果已经向客户端发送包头信息了，你还可以将错误处理交给 Express 内置的错误处理机制。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">function</span> <span class="token function">errorHandler<span class="token punctuation">(</span></span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>headersSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">next<span class="token punctuation">(</span></span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

      
    </section>

    <a id="top" href="http://www.expressjs.com.cn/guide/error-handling.html#"><img src="./10Express 中的错误处理_files/arrow.png"></a>
    
    <footer>
        <div id="footer-content">
            <div id="github">
                <a href="https://github.com/strongloop/express" target="_blank">Github Repo</a>
            </div>
            <div id="sponsor">Express 项目由 <a href="http://strongloop.com/" target="_blank">StrongLoop</a> 赞助。</div>
            <div id="fork"><a href="https://github.com/strongloop/expressjs.com/blob/gh-pages/guide/error-handling.md">Edit this page on GitHub</a></div>
            <div>Copyright © StrongLoop, Inc., and other expressjs.com contributors.</div>
        </div>
    
        <div class="friend-links">
            <a href="http://www.bootcss.com/" title="Bootstrap 中文网">Bootstrap中文网</a>
            <a href="http://www.gruntjs.net/" title="Grunt 中文网">Grunt中文网</a>
            <a href="http://www.gulpjs.com.cn/" title="Gulp 中文网">Gulp中文网</a>
            <a href="http://www.bootcdn.cn/" title="BootCDN 加速">BootCDN</a>
            <a href="http://www.nodeapp.cn/" title="Node.js 中文文档">Node.js 中文文档</a>
        </div>
    </footer>
    
    <div class="beian">
    	<a href="http://www.miibeian.gov.cn/" target="_blank">冀ICP备15008021号</a><span>|</span>© Express 中文网 2015
    </div>
  


</body></html>