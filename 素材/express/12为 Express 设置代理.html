<!DOCTYPE html>
<!-- saved from url=(0053)http://www.expressjs.com.cn/guide/behind-proxies.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>为 Express 设置代理</title>
      
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <link rel="stylesheet" href="./12为 Express 设置代理_files/style.css">
      <link rel="stylesheet" href="./12为 Express 设置代理_files/dropit.css">
      <link rel="stylesheet" href="./12为 Express 设置代理_files/prism.css">
      <link href="./12为 Express 设置代理_files/font-awesome.min.css" rel="stylesheet">
      <link rel="stylesheet" href="./12为 Express 设置代理_files/css">
  
      <script src="./12为 Express 设置代理_files/hm.js.下载"></script><script src="./12为 Express 设置代理_files/hm.js(1).下载"></script><script data-cfasync="false" src="./12为 Express 设置代理_files/jquery.min.js.下载"></script>
      <script data-cfasync="false" src="./12为 Express 设置代理_files/app.js.下载"></script>
      <script data-cfasync="false" src="./12为 Express 设置代理_files/retina.js.下载"></script>
      <script data-cfasync="false" src="./12为 Express 设置代理_files/dropit.js.下载"></script>
      <script data-cfasync="false" src="./12为 Express 设置代理_files/prism.js.下载"></script>
      <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?1e9527683dc35951cb595bc55ece8e84";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script></head>

  <body rlt="1" class="">

    <section class="content">

      <header>
        <div id="mobile-menu">
            <div id="nav-button" class="fa fa-bars fa-2x button"></div>
        </div>
        <section id="logo"><a href="http://www.expressjs.com.cn/" class="express">Express</a>
        </section>
        <div id="navbar">
            <ul id="navmenu">
                <li><a href="http://www.expressjs.com.cn/" id="home-menu">首页</a></li>
                <li>
                    <ul id="getting-started-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/starter/installing.html">入门</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/installing.html">
                                    安装
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/hello-world.html">
                                    Hello world
                                  </a>
                                </li>
                                <li>
                                <a href="http://www.expressjs.com.cn/starter/generator.html">
                                  Express 应用生成器
                                </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/basic-routing.html">
                                    基本路由
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/static-files.html">
                                    静态文件
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/faq.html">
                                    常见问题
                                  </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="guide-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/guide/routing.html">使用指南</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/guide/routing.html">路由</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/error-handling.html">错误处理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/debugging.html">调试</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/behind-proxies.html">为 Express 设置代理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/migrating-4.html">升级到 Express 4</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/database-integration.html">数据库集成</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="application-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/4x/api.html">API 中文手册</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/4x/api.html">4.x 版本</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/3x/api.html">3.x 版本</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="advanced-topics-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">进阶话题</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/pm.html">进程管理器</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/security-updates.html">安全更新</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="resources-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/resources/glossary.html">有用的资源</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/resources/glossary.html">术语表</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/community.html">社区</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/books-blogs.html">书籍与博客</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/applications.html">实例展示</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
      </header>
      <div id="overlay"></div>
    
      
<h1 id="express-">为 Express 设置代理</h1>

<p>当在代理服务器之后运行 Express 时，请将应用变量 <code>trust proxy</code> 设置（使用 <a href="http://www.expressjs.com.cn/4x/api.html#app.set">app.set()</a>）为下述列表中的一项。</p>

<div class="doc-box doc-info">
  <p>如果没有设置应用变量 <code>trust proxy</code>，应用将不会运行，除非 <code>trust proxy</code> 设置正确，否则应用会误将代理服务器的 IP 地址注册为客户端 IP 地址。</p>
</div>

<table class="doctable" border="1">
  <thead><tr><th>类型</th><th>值</th></tr></thead>
  <tbody>
    <tr>
      <td>Boolean</td>
<td>
        <p>如果为 <code>true</code>，客户端 IP 地址为 <code>X-Forwarded-*</code> 头最左边的项。</p>

        <p>如果为 <code>false</code>, 应用直接面向互联网，客户端 IP 地址从 <code>req.connection.remoteAddress</code> 得来，这是默认的设置。</p>
      </td>
    </tr>
    <tr>
      <td>IP 地址</td>
<td>
        <p>IP 地址、子网或 IP 地址数组和可信的子网。下面是预配置的子网列表。</p>

        <ul>
          <li>loopback - <code>127.0.0.1/8</code>, <code>::1/128</code></li>
          <li>linklocal - <code>169.254.0.0/16</code>, <code>fe80::/10</code></li>
          <li>uniquelocal - <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>, <code>fc00::/7</code></li>
        </ul>

        <p>使用如下方式设置 IP 地址：</p>

        <pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定唯一子网
</span>app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback, 123.123.123.123'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定子网和 IP 地址
</span>app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback, linklocal, uniquelocal'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 指定多个子网
</span>app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'loopback'</span><span class="token punctuation">,</span> <span class="token string">'linklocal'</span><span class="token punctuation">,</span> <span class="token string">'uniquelocal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 使用数组指定多个子网</span></code></pre>

        <p>当指定地址时，IP 地址或子网从地址确定过程中被除去，离应用服务器最近的非受信 IP 地址被当作客户端 IP 地址。</p>
      </td>
    </tr>
    <tr>
      <td>Number</td>
<td>
        <p>将代理服务器前第 <code>n</code> 跳当作客户端。</p>
      </td>
    </tr>
    <tr>
      <td>Function</td>
<td>
        <p>定制实现，只有在您知道自己在干什么时才能这样做。</p>
        <pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ip <span class="token operator">===</span> <span class="token string">'127.0.0.1'</span> <span class="token operator">||</span> ip <span class="token operator">===</span> <span class="token string">'123.123.123.123'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 受信的 IP 地址
</span>  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
      </td>
    </tr>
  </tbody>
</table>

<p>设置 <code>trust proxy</code> 为非假值会带来两个重要变化：</p>

<ul>
  <li>
    <p>反向代理可能设置 <code>X-Forwarded-Proto</code> 来告诉应用使用 https 或简单的 http 协议。请参考 <a href="http://www.expressjs.com.cn/api.html#req.protocol">req.protocol</a>。</p>
  </li>
  <li>
    <p><a href="http://www.expressjs.com.cn/api.html#req.ip">req.ip</a> 和 <a href="http://www.expressjs.com.cn/api.html#req.ips">req.ips</a> 的值将会由 <code>X-Forwarded-For</code> 中列出的 IP 地址构成。</p>
  </li>
</ul>

<p><code>trust proxy</code> 设置由 <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a> 软件包实现，请参考其文档了解更多信息。</p>

      
    </section>

    <a id="top" href="http://www.expressjs.com.cn/guide/behind-proxies.html#"><img src="./12为 Express 设置代理_files/arrow.png"></a>
    
    <footer>
        <div id="footer-content">
            <div id="github">
                <a href="https://github.com/strongloop/express" target="_blank">Github Repo</a>
            </div>
            <div id="sponsor">Express 项目由 <a href="http://strongloop.com/" target="_blank">StrongLoop</a> 赞助。</div>
            <div id="fork"><a href="https://github.com/strongloop/expressjs.com/blob/gh-pages/guide/behind-proxies.md">Edit this page on GitHub</a></div>
            <div>Copyright © StrongLoop, Inc., and other expressjs.com contributors.</div>
        </div>
    
        <div class="friend-links">
            <a href="http://www.bootcss.com/" title="Bootstrap 中文网">Bootstrap中文网</a>
            <a href="http://www.gruntjs.net/" title="Grunt 中文网">Grunt中文网</a>
            <a href="http://www.gulpjs.com.cn/" title="Gulp 中文网">Gulp中文网</a>
            <a href="http://www.bootcdn.cn/" title="BootCDN 加速">BootCDN</a>
            <a href="http://www.nodeapp.cn/" title="Node.js 中文文档">Node.js 中文文档</a>
        </div>
    </footer>
    
    <div class="beian">
    	<a href="http://www.miibeian.gov.cn/" target="_blank">冀ICP备15008021号</a><span>|</span>© Express 中文网 2015
    </div>
  


</body></html>