<!DOCTYPE html>
<!-- saved from url=(0055)http://www.expressjs.com.cn/guide/using-middleware.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>使用 Express 中间件</title>
      
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <link rel="stylesheet" href="./8使用 Express 中间件_files/style.css">
      <link rel="stylesheet" href="./8使用 Express 中间件_files/dropit.css">
      <link rel="stylesheet" href="./8使用 Express 中间件_files/prism.css">
      <link href="./8使用 Express 中间件_files/font-awesome.min.css" rel="stylesheet">
      <link rel="stylesheet" href="./8使用 Express 中间件_files/css">
  
      <script src="./8使用 Express 中间件_files/hm.js.下载"></script><script src="./8使用 Express 中间件_files/hm.js(1).下载"></script><script data-cfasync="false" src="./8使用 Express 中间件_files/jquery.min.js.下载"></script>
      <script data-cfasync="false" src="./8使用 Express 中间件_files/app.js.下载"></script>
      <script data-cfasync="false" src="./8使用 Express 中间件_files/retina.js.下载"></script>
      <script data-cfasync="false" src="./8使用 Express 中间件_files/dropit.js.下载"></script>
      <script data-cfasync="false" src="./8使用 Express 中间件_files/prism.js.下载"></script>
      <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?1e9527683dc35951cb595bc55ece8e84";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script></head>

  <body rlt="1">

    <section class="content">

      <header>
        <div id="mobile-menu">
            <div id="nav-button" class="fa fa-bars fa-2x button"></div>
        </div>
        <section id="logo"><a href="http://www.expressjs.com.cn/" class="express">Express</a>
        </section>
        <div id="navbar">
            <ul id="navmenu">
                <li><a href="http://www.expressjs.com.cn/" id="home-menu">首页</a></li>
                <li>
                    <ul id="getting-started-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/starter/installing.html">入门</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/installing.html">
                                    安装
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/hello-world.html">
                                    Hello world
                                  </a>
                                </li>
                                <li>
                                <a href="http://www.expressjs.com.cn/starter/generator.html">
                                  Express 应用生成器
                                </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/basic-routing.html">
                                    基本路由
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/static-files.html">
                                    静态文件
                                  </a>
                                </li>
                                <li>
                                  <a href="http://www.expressjs.com.cn/starter/faq.html">
                                    常见问题
                                  </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="guide-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/guide/routing.html">使用指南</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/guide/routing.html">路由</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/using-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/error-handling.html">错误处理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/debugging.html">调试</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/behind-proxies.html">为 Express 设置代理</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/migrating-4.html">升级到 Express 4</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/guide/database-integration.html">数据库集成</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="application-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/4x/api.html">API 中文手册</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/4x/api.html">4.x 版本</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/3x/api.html">3.x 版本</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="advanced-topics-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">进阶话题</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/advanced/developing-template-engines.html">模板引擎</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/pm.html">进程管理器</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/advanced/security-updates.html">安全更新</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>
                    <ul id="resources-menu" class="menu dropit">
                        <li class="dropit-trigger"><a href="http://www.expressjs.com.cn/resources/glossary.html">有用的资源</a>
                            <ul class="dropit-submenu" style="display: none;">
                                <li><a href="http://www.expressjs.com.cn/resources/glossary.html">术语表</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/middleware.html">中间件</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/community.html">社区</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/books-blogs.html">书籍与博客</a>
                                </li>
                                <li><a href="http://www.expressjs.com.cn/resources/applications.html">实例展示</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
      </header>
      <div id="overlay"></div>
    
      
<h1 id="section">使用中间件</h1>

<p>Express 是一个自身功能极简，完全是由路由和中间件构成一个的 web 开发框架：从本质上来说，一个 Express 应用就是在调用各种中间件。</p>

<p><em>中间件（Middleware）</em> 是一个函数，它可以访问请求对象（<a href="http://www.expressjs.com.cn/4x/api.html#req">request object</a> (<code>req</code>)）, 响应对象（<a href="http://www.expressjs.com.cn/4x/api.html#res">response object</a> (<code>res</code>)）, 和 web 应用中处于请求-响应循环流程中的中间件，一般被命名为 <code>next</code> 的变量。</p>

<p>中间件的功能包括：</p>

<ul>
  <li>执行任何代码。</li>
  <li>修改请求和响应对象。</li>
  <li>终结请求-响应循环。</li>
  <li>调用堆栈中的下一个中间件。</li>
</ul>

<p>如果当前中间件没有终结请求-响应循环，则必须调用 <code>next()</code> 方法将控制权交给下一个中间件，否则请求就会挂起。</p>

<p>Express 应用可使用如下几种中间件：</p>

<ul>
  <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html#middleware.application">应用级中间件</a></li>
  <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html#middleware.router">路由级中间件</a></li>
  <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html#middleware.error-handling">错误处理中间件</a></li>
  <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html#middleware.built-in">内置中间件</a></li>
  <li><a href="http://www.expressjs.com.cn/guide/using-middleware.html#middleware.third-party">第三方中间件</a></li>
</ul>

<p>使用可选则挂载路径，可在应用级别或路由级别装载中间件。另外，你还可以同时装在一系列中间件函数，从而在一个挂载点上创建一个子中间件栈。</p>

<h2 id="middleware.application">应用级中间件</h2>

<p>应用级中间件绑定到 <a href="http://www.expressjs.com.cn/4x/api.html#app">app 对象</a> 使用 <code>app.use()</code> 和 <code>app.METHOD()</code>，
其中， <code>METHOD</code> 是需要处理的 HTTP 请求的方法，例如 GET, PUT, POST 等等，全部小写。例如：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 没有挂载路径的中间件，应用的每个请求都会执行该中间件
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Time:'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 挂载至 /user/:id 的中间件，任何指向 /user/:id 的请求都会执行它
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Request Type:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 路由和句柄函数(中间件系统)，处理指向 /user/:id 的 GET 请求
</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'USER'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>下面这个例子展示了在一个挂载点装载一组中间件。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token comment" spellcheck="true">// 一个中间件栈，对任何指向 /user/:id 的 HTTP 请求打印出相关信息
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Request URL:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Request Type:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>作为中间件系统的路由句柄，使得为路径定义多个路由成为可能。在下面的例子中，为指向 <code>/user/:id</code> 的 GET 请求定义了两个路由。第二个路由虽然不会带来任何问题，但却永远不会被调用，因为第一个路由已经终止了请求-响应循环。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token comment" spellcheck="true">// 一个中间件栈，处理指向 /user/:id 的 GET 请求
</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'ID:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'User Info'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 处理 /user/:id， 打印出用户 id
</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">end<span class="token punctuation">(</span></span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>如果需要在中间件栈中跳过剩余中间件，调用 <code>next('route')</code> 方法将控制权交给下一个路由。
<strong>注意</strong>： <code>next('route')</code> 只对使用 <code>app.VERB()</code> 或 <code>router.VERB()</code> 加载的中间件有效。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token comment" spellcheck="true">// 一个中间件栈，处理指向 /user/:id 的 GET 请求
</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 如果 user id 为 0, 跳到下一个路由
</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">next<span class="token punctuation">(</span></span><span class="token string">'route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 否则将控制权交给栈中下一个中间件
</span>  <span class="token keyword">else</span> <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//
</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 渲染常规页面
</span>  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'regular'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 处理 /user/:id， 渲染一个特殊页面
</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'special'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<h2 id="middleware.router">路由级中间件</h2>

<p>路由级中间件和应用级中间件一样，只是它绑定的对象为 <code>express.Router()</code>。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>路由级使用 <code>router.use()</code> 或 <code>router.VERB()</code> 加载。</p>

<p>上述在应用级创建的中间件系统，可通过如下代码改写为路由级：</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 没有挂载路径的中间件，通过该路由的每个请求都会执行该中间件
</span>router<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Time:'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 一个中间件栈，显示任何指向 /user/:id 的 HTTP 请求的信息
</span>router<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Request URL:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>originalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Request Type:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 一个中间件栈，处理指向 /user/:id 的 GET 请求
</span>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 如果 user id 为 0, 跳到下一个路由
</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">next<span class="token punctuation">(</span></span><span class="token string">'route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 负责将控制权交给栈中下一个中间件
</span>  <span class="token keyword">else</span> <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//
</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 渲染常规页面
</span>  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'regular'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 处理 /user/:id， 渲染一个特殊页面
</span>router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render<span class="token punctuation">(</span></span><span class="token string">'special'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 将路由挂载至应用
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token string">'/'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<h2 id="middleware.error-handling">错误处理中间件</h2>

<div class="doc-box doc-notice">
  <p>错误处理中间件有 <em>4</em> 个参数，定义错误处理中间件时必须使用这 4 个参数。即使不需要 <code>next</code> 对象，也必须在签名中声明它，否则中间件会被识别为一个常规中间件，不能处理错误。</p>
</div>

<p>错误处理中间件和其他中间件定义类似，只是要使用 4 个参数，而不是 3 个，其签名如下： <code>(err, req, res, next)</code>。</p>

<pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error<span class="token punctuation">(</span></span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">status<span class="token punctuation">(</span></span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span><span class="token string">'Something broke!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>请参考 <a href="http://www.expressjs.com.cn/guide/error-handling.html">错误处理</a> 一章了解更多关于错误处理中间件的内容。</p>

<h2 id="middleware.built-in">内置中间件</h2>

<p>从 4.x 版本开始，, Express 已经不再依赖 <a href="https://github.com/senchalabs/connect">Connect</a> 了。除了 <code>express.static</code>, Express 以前内置的中间件现在已经全部单独作为模块安装使用了。请参考 <a href="https://github.com/senchalabs/connect#middleware">中间件列表</a>。</p>

<h4 id="express.static">express.static(root, [options])</h4>

<p><code>express.static</code> 是 Express 唯一内置的中间件。它基于 <a href="https://github.com/expressjs/serve-static">serve-static</a>，负责在 Express 应用中提托管静态资源。</p>

<p>参数 <code>root</code> 指提供静态资源的根目录。</p>

<p>可选的 <code>options</code> 参数拥有如下属性。</p>

<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>描述</th>
      <th>类型</th>
      <th>缺省值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dotfiles</code></td>
      <td>是否对外输出文件名以点（<code>.</code>）开头的文件。可选值为 “allow”、“deny” 和 “ignore”</td>
      <td>String</td>
      <td>“ignore”</td>
    </tr>
    <tr>
      <td><code>etag</code></td>
      <td>是否启用 etag 生成</td>
      <td>Boolean</td>
      <td><code>true</code></td>
    </tr>
    <tr>
      <td><code>extensions</code></td>
      <td>设置文件扩展名备份选项</td>
      <td>Array</td>
      <td><code>[]</code></td>
    </tr>
    <tr>
      <td><code>index</code></td>
      <td>发送目录索引文件，设置为 <code>false</code> 禁用目录索引。</td>
      <td>Mixed</td>
      <td>“index.html”</td>
    </tr>
    <tr>
      <td><code>lastModified</code></td>
      <td>设置 <code>Last-Modified</code> 头为文件在操作系统上的最后修改日期。可能值为 <code>true</code> 或 <code>false</code>。</td>
      <td>Boolean</td>
      <td><code>true</code></td>
    </tr>
    <tr>
      <td><code>maxAge</code></td>
      <td>以毫秒或者其<a href="https://www.npmjs.org/package/ms">字符串格式</a>设置 Cache-Control 头的 max-age 属性。</td>
      <td>Number</td>
      <td>0</td>
    </tr>
    <tr>
      <td><code>redirect</code></td>
      <td>当路径为目录时，重定向至 “/”。</td>
      <td>Boolean</td>
      <td><code>true</code></td>
    </tr>
    <tr>
      <td><code>setHeaders</code></td>
      <td>设置 HTTP 头以提供文件的函数。</td>
      <td>Function</td>
      <td>&nbsp;</td>
    </tr>
  </tbody>
</table>

<p>下面的例子使用了 <code>express.static</code> 中间件，其中的 <code>options</code> 对象经过了精心的设计。</p>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  dotfiles<span class="token punctuation">:</span> <span class="token string">'ignore'</span><span class="token punctuation">,</span>
  etag<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'htm'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  index<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> <span class="token string">'1d'</span><span class="token punctuation">,</span>
  redirect<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  setHeaders<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">,</span> path<span class="token punctuation">,</span> stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'x-timestamp'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>每个应用可有多个静态目录。</p>

<pre class="  language-javascript"><code class="  language-javascript">app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'uploads'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>更多关于 <code>serve-static</code> 和其参数的信息，请参考 <a href="https://github.com/expressjs/serve-static">serve-static</a> 文档。</p>

<h2 id="middleware.third-party">第三方中间件</h2>

<p>通过使用第三方中间件从而为 Express 应用增加更多功能。</p>

<p>安装所需功能的 node 模块，并在应用中加载，可以在应用级加载，也可以在路由级加载。</p>

<p>下面的例子安装并加载了一个解析 cookie 的中间件： <code>cookie-parser</code></p>

<pre class="language-sh"><code class="language-sh">$ npm install cookie-parser
</code></pre>

<pre class="  language-javascript"><code class="  language-javascript"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require<span class="token punctuation">(</span></span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 加载用于解析 cookie 的中间件
</span>app<span class="token punctuation">.</span><span class="token function">use<span class="token punctuation">(</span></span><span class="token function">cookieParser<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<p>请参考 <a href="http://www.expressjs.com.cn/resources/middleware.html">第三方中间件</a> 获取 Express 中经常用到的第三方中间件列表。</p>

      
    </section>

    <a id="top" href="http://www.expressjs.com.cn/guide/using-middleware.html#"><img src="./8使用 Express 中间件_files/arrow.png"></a>
    
    <footer>
        <div id="footer-content">
            <div id="github">
                <a href="https://github.com/strongloop/express" target="_blank">Github Repo</a>
            </div>
            <div id="sponsor">Express 项目由 <a href="http://strongloop.com/" target="_blank">StrongLoop</a> 赞助。</div>
            <div id="fork"><a href="https://github.com/strongloop/expressjs.com/blob/gh-pages/guide/using-middleware.md">Edit this page on GitHub</a></div>
            <div>Copyright © StrongLoop, Inc., and other expressjs.com contributors.</div>
        </div>
    
        <div class="friend-links">
            <a href="http://www.bootcss.com/" title="Bootstrap 中文网">Bootstrap中文网</a>
            <a href="http://www.gruntjs.net/" title="Grunt 中文网">Grunt中文网</a>
            <a href="http://www.gulpjs.com.cn/" title="Gulp 中文网">Gulp中文网</a>
            <a href="http://www.bootcdn.cn/" title="BootCDN 加速">BootCDN</a>
            <a href="http://www.nodeapp.cn/" title="Node.js 中文文档">Node.js 中文文档</a>
        </div>
    </footer>
    
    <div class="beian">
    	<a href="http://www.miibeian.gov.cn/" target="_blank">冀ICP备15008021号</a><span>|</span>© Express 中文网 2015
    </div>
  


</body></html>